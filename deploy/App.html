<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!-- Copyright (c) 2012 Rally Software Development Corp. All rights reserved -->
<html>
<head>
  <title>Planned vs Actual Burndown</title>
  <meta name="Name" content="App: Planned vs Actual Burndown" />
  <meta name="Version" content="2012.11.19" />
  <meta name="Vendor" content="Rally Software" />

  <script type ="text/javascript" src="https://rally1.rallydev.com/apps/1.32/sdk.js"></script>
  <script type ="text/javascript">
    function PlannedVsActualBurndown() {
        this.display = function() {
            dojo.require("dojox.charting.Chart2D");
            var iterations = {};
            var waiter, releaseDropdown, aggregatedTable, chart;
    
            var showLegend = function() {
                dojo.byId("legendDiv").innerHTML =
                        "<div class='blue box'></div> Actual Burndown&nbsp;&nbsp;&nbsp;<div class='green box'></div> Planned Burndown";
            };
    
            var buildLineChart = function() {
                var labels = [];
                var plannedBurndown = [];
                var actualBurndownPast = [];
                var actualBurndownFuture = [];
                var zeros = [];
    
                var i = 1;
                var futureCount = 0;
                rally.forEach(iterations, function(value) {
                    labels.push({value: i, text: value.Name});
                    plannedBurndown.push(value.PlannedBurndown);
                    if (value.IsFuture && futureCount === 0) {  // past/future plot point
                        futureCount = 1;
                        actualBurndownPast.push(value.ActualBurndown);
                        actualBurndownFuture.push(value.ActualBurndown);
                    } else if (value.IsFuture && futureCount > 0) {  // future plot points
                        actualBurndownPast.push(null);
                        actualBurndownFuture.push(value.ActualBurndown);
                    } else { // past plot points
                        actualBurndownPast.push(value.ActualBurndown);
                        actualBurndownFuture.push(null);
                    }
                    zeros.push(0);
                    i++;
                });
    
                chart = new dojox.charting.Chart2D("lineChartDiv");
                chart.addPlot("default", {type: "Lines"});
                chart.addAxis("x", {labels: labels});
                chart.addAxis("y", {vertical: true});
                chart.addSeries("Planned Burndown", plannedBurndown, {stroke: {color:"#666666", style: "LongDash"}});
                chart.addSeries("Actual Burndown Past", actualBurndownPast, {stroke: {color:"#5C9ACB"}});
                chart.addSeries("Actual Burndown Future", actualBurndownFuture, {stroke: {color:"#5C9ACB", style: "LongDash"}});
                chart.addSeries("Zero Axis", zeros, {stroke: {color:"black", width:1}});
                chart.render();
                chart.resize(550,300);
    
                showLegend();
            };
    
            var populateTable = function(table) {
                function formatDate(date) {
                    if (date === "") {
                        return "";
                    }
                    return dojo.date.locale.format(dojo.date.stamp.fromISOString(date.replace(/Z/, "")), {datePattern: "yyyy-MM-dd", selector: "date"});
                }
    
                var i = 0;
                rally.forEach(iterations, function(value) {
                    var colorClass = value.IsFuture ? "greyText" : "blueText";
                    console.log(value.ActualVelocity , value.Resources)
                    table.setCell(i, 0, value.Name + "(" + value.Project + ")");
                    table.setCell(i, 1, formatDate(value.StartDate));
                    table.setCell(i, 2, formatDate(value.EndDate));
                    table.setCell(i, 3, '' + value.PlanEstimate);   // planEstimate
                    table.setCell(i, 4, '' + value.ActualVelocity); // ActualVelocity
                    table.setCell(i, 5, '' + value.Resources);      // PlannedVelocity
                    //table.setCell(i, 6, '' + ( value.PlanEstimate > 0 ? Math.round( ( value.ActualVelocity / value.PlanEstimate) * 100):0));
                    table.setCell(i, 6, '' + ( ( value.Resources != null && value.Resources > 0 ) ? Math.round( ( value.ActualVelocity / value.Resources ) * 100):0)); // %
                    table.setCell(i, 7, "<span class='" + colorClass + "'>" + value.ActualBurndown + "</span>"); // ActualBurndown
                    table.setCell(i, 8, "<span class='greenText'>" + value.PlannedBurndown + "</span>"); // PlannedBurndown
                    i++;
                });
            };
    
            var showTable = function(releasePlanEstimate) {
                var aggregatedTableConfig = {
                    'sortingEnabled': false,
                    'columnKeys'    : ['Iteration Name', 'Start Date', 'End Date', 'Plan Estimate', 'Actual Vel.', 'Planned Vel.', '%', 'Actual Burn', 'Planned Burn'],
                    'width'         : '550px'
                };
                aggregatedTable = new rally.sdk.ui.Table(aggregatedTableConfig);
                populateTable(aggregatedTable);
                waiter.hide();
                dojo.byId('planEstimateDiv').innerHTML = 'Release Plan Estimate: ' + releasePlanEstimate;
                dojo.byId("legendDiv").style.display = "";
                dojo.byId("planEstimateDiv").style.display = "";
                dojo.byId("aggregatedDataDiv").style.display = "";
                aggregatedTable.display("aggregatedDataDiv");
    
                buildLineChart();
            };
    
            var aggregateBurndown = function(releasePlanEstimate) {
                function getRallyDate(jsDate) {
                    var yr = jsDate.getUTCFullYear();
                    var mon = ("0" + (jsDate.getUTCMonth() + 1));
                    var day = ("0" + jsDate.getUTCDate()).substr(-2);
                    var hr = ("0" + jsDate.getUTCHours()).substr(-2);
                    var min = ("0" + jsDate.getUTCMinutes()).substr(-2);
                    var sec = ("0" + jsDate.getUTCSeconds()).substr(-2);
    
                    return       yr +
                            "-" + mon.substr(mon.length - 2, 2) +
                            "-" + day.substr(day.length - 2, 2) +
                            "T" + hr + ":" + min + ":" + sec;
                }
    
                var actualBurndown, plannedBurndown, future, lastPlannedVelocity, lastActualVelocity;
                var today = getRallyDate(new Date());
                var i = 1;
    
                rally.forEach(iterations, function(value) {
                    if (i === 1) {                               // first iteration
                        actualBurndown = releasePlanEstimate;
                        plannedBurndown = releasePlanEstimate;
                        future = value.EndDate >= today;
                    } else if (value.Name === "Release") {       //release row
                        if (future) {
                            actualBurndown -= lastPlannedVelocity;
                            plannedBurndown -= lastPlannedVelocity;
                        } else {
                            actualBurndown -= lastActualVelocity;
                            plannedBurndown -= lastPlannedVelocity;
                        }
                    } else if (value.EndDate >= today) {         // future iteration
                        actualBurndown -= lastPlannedVelocity;
                        plannedBurndown -= lastPlannedVelocity;
                        future = true;
                    } else if (value.EndDate < today) {         // past iteration
                        actualBurndown -= lastActualVelocity;
                        plannedBurndown -= lastPlannedVelocity;
                        future = false;
                    }
                    lastPlannedVelocity = value.Resources;
                    lastActualVelocity = value.ActualVelocity;
    
                    iterations[value.Name].ActualBurndown = actualBurndown;
                    iterations[value.Name].PlannedBurndown = plannedBurndown;
                    iterations[value.Name].IsFuture = future;
                    console.log("value",value);
                    i++;
                });
    
                showTable(releasePlanEstimate);
            };
    
            var aggregateData = function(results) {
                var releasePlanEstimate = 0;
                var allStoriesDefectsDefectSuites = results.stories;
                allStoriesDefectsDefectSuites = allStoriesDefectsDefectSuites.concat(results.defects);
                allStoriesDefectsDefectSuites = allStoriesDefectsDefectSuites.concat(results.defectSuites);
    
                dojo.forEach(allStoriesDefectsDefectSuites, function(item) { //aggregate story, defect, & defect suite data
                    var estimate = item.PlanEstimate || 0;
    
                    iterations[item.Iteration.Name].PlanEstimate += estimate;
                    releasePlanEstimate += estimate;
                    if (item.ScheduleState === 'Accepted') {
                        iterations[item.Iteration.Name].ActualVelocity += estimate;
                    }
                });
    
                aggregateBurndown(releasePlanEstimate);
            };
    
            var makeIterationObjects = function(results) {
                dojo.forEach(results.iterations, function(iteration) {
                    var resources = iteration.Resources || 0;
                    if (iterations[iteration.Name]) {
                        resources = resources + iterations[iteration.Name].Resources;
                    }
    
                    iterations[iteration.Name] = {
                        _ref:           iteration._ref,
                        Name:           iteration.Name ,
                        StartDate:      iteration.StartDate,
                        EndDate:        iteration.EndDate,
                        Resources:      resources,
                        PlanEstimate:   0,
                        ActualVelocity: 0,
                        ActualBurndown: 0,
                        PlannedBurndown:0,
                        IsFuture:       "",
                        Project: iteration.Project.Name};
                });
    
                iterations.Release = {
                    _ref:           "",
                    Name:           "Release",
                    StartDate:      "",
                    EndDate:        "",
                    Resources:      "",
                    PlanEstimate:   "",
                    ActualVelocity: "",
                    ActualBurndown: 0,
                    PlannedBurndown:0,
                    IsFuture:       ""};
    
    
                aggregateData(results);
            };
    
            function clearComponents() {
                dojo.byId("legendDiv").style.display = "none";
                dojo.byId("planEstimateDiv").style.display = "none";
                dojo.byId("aggregatedDataDiv").style.display = "none";
    
                waiter.display("waiter");
                iterations = {};
    
                if (chart) {
                    chart.destroy();
                }
    
                if (aggregatedTable) {
                    aggregatedTable.destroy();
                    aggregatedTable = null;
                }
            }
    
            function releaseSelected() {
                clearComponents();
    
                var queryConfig = [];
                var typeArray = ['hierarchicalrequirement','Defect','DefectSuite'];
                var keyArray = ['stories','defects','defectSuites'];
    
                dojo.forEach(typeArray, function(query, i) {
                    queryConfig.push({
                        type : typeArray[i],
                        key  : keyArray[i],
                        query:  rally.sdk.util.Query.and(['Iteration.StartDate >= "' + releaseDropdown.getSelectedStart() + '"',
                            'Iteration.StartDate <= "' + releaseDropdown.getSelectedEnd() + '"']).or(
                                rally.sdk.util.Query.and(['Iteration.EndDate >= "' + releaseDropdown.getSelectedStart() + '"',
                                    'Iteration.EndDate <= "' + releaseDropdown.getSelectedEnd() + '"'])),
                        fetch: 'Name,Iteration,ScheduleState,PlanEstimate,Project'
                    });
                });
    
                queryConfig.push({
                    type : 'Iterations',
                    key  : 'iterations',
                    query:  rally.sdk.util.Query.and(['StartDate >= "' + releaseDropdown.getSelectedStart() + '"',
                        'StartDate <= "' + releaseDropdown.getSelectedEnd() + '"']).or(
                            rally.sdk.util.Query.and(['EndDate >= "' + releaseDropdown.getSelectedStart() + '"',
                                'EndDate <= "' + releaseDropdown.getSelectedEnd() + '"'])),
                    fetch: 'Name,Resources,StartDate,EndDate,Project',
                    order: 'EndDate'
                });
    
                rallyDataSource.findAll(queryConfig, makeIterationObjects);
            }
    
            rally.sdk.ui.AppHeader.setHelpTopic("240");
            rally.sdk.ui.AppHeader.showPageTools(true);
    
            rallyDataSource = new rally.sdk.data.RallyDataSource('__WORKSPACE_OID__',
                    '__PROJECT_OID__',
                    '__PROJECT_SCOPING_UP__',
                    '__PROJECT_SCOPING_DOWN__');
    
            releaseDropdown = new rally.sdk.ui.ReleaseDropdown({}, rallyDataSource);
    
            waiter = new rally.sdk.ui.basic.Wait({hideTarget:false});
            waiter.display("waiter");
    
            dojo.addOnLoad(function() {  //executes when dojo requirements are loaded
                releaseDropdown.display("dropdownDiv", releaseSelected);
            });
        };
    }
  </script>

  <style type="text/css">
        .box {
        display: inline-block;
        height: 10px;
        width: 10px;
    }
    
    .blue {
        background-color: #5C9ACB;
    }
    
    .green {
        background-color: #666666;
    }
    
    .greenText {
        color: #666666;
    }
    
    .blueText {
        color: #5C9ACB;
    }
    
    .greyText {
        color: #999999;
    }
    
    #aggregatedDataDiv,
    #legendDiv {
        padding-top: 10px;
    }
    
    #lineChartDiv,
    #planEstimateDiv,
    #legendDiv,
    #waiter {
        width: 550px;
    }
    
    #planEstimateDiv,
    #legendDiv {
        text-align: right;
        font-size: 12px;
    }
  </style>

  <script type="text/javascript">
    function onLoad() {
      var appCustom = new PlannedVsActualBurndown();
      appCustom.display();
    }

    rally.addOnLoad(onLoad);
  </script>
</head>

<body>
  <div id="waiter"></div>
  <div id="releaseDiv"></div>
  <div id="dropdownDiv"></div>

  <div id="legendDiv"></div>
  <div id="lineChartDiv"></div>
  <div id="planEstimateDiv"></div>
  <div id="aggregatedDataDiv"></div>
</body>
</html>
